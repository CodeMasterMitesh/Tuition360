// leaves.js - per-page JS for Leaves
function initLeaves() {
    try { initAdvancedTable('#leaves-table'); } catch(e){ console.error('initLeaves: initAdvancedTable failed', e); }
    const container = document.querySelector('.dashboard-container'); if (container) container.classList.add('show');

    // Keyboard: Ctrl+F focus filter, Ctrl+N add
    document.addEventListener('keydown', function(e){ if (e.ctrlKey && e.key === 'f') { e.preventDefault(); const input=document.querySelector('#leaves-table thead tr.filters input'); if (input) { input.focus(); input.select && input.select(); } } if (e.ctrlKey && e.key === 'n') { e.preventDefault(); const btn=document.querySelector('[data-modal-target="#addLeaveModal"]') || document.querySelector('[data-bs-target="#addLeaveModal"]'); btn && btn.click(); } });
}
if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', initLeaves); else try { initLeaves(); } catch(e){ console.error('initLeaves immediate failed', e); }

function exportToExcel(){ if (window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>{ window.location.href='?page=leaves&export=excel'; if (window.CRUD && CRUD.hideLoading) CRUD.hideLoading(); },800); }
function refreshTable(){ if (window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>location.reload(),700); }

async function viewLeave(id){ if (window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const res = await CRUD.get(`api/leaves.php?action=get&id=${encodeURIComponent(id)}`); if (res.success && res.data){ const a = res.data; document.getElementById('leaveId').value = a.id || ''; document.querySelector('#addLeaveForm [name="employee"]').value = a.employee || ''; document.querySelector('#addLeaveForm [name="from_date"]').value = a.from_date || ''; document.querySelector('#addLeaveForm [name="to_date"]').value = a.to_date || ''; document.querySelector('#addLeaveForm [name="type"]').value = a.type || ''; const form = document.getElementById('addLeaveForm'); if (form) Array.from(form.elements).forEach(el=>el.disabled=true); const saveBtn=document.querySelector('#addLeaveModal .btn-primary'); if(saveBtn) saveBtn.style.display='none'; document.querySelector('#addLeaveModal .modal-title').innerText='View Leave'; bootstrap.Modal.getOrCreateInstance(document.getElementById('addLeaveModal')).show(); } else { window.CRUD && CRUD.toastError && CRUD.toastError('Record not found'); } } catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Failed: '+e.message); } finally { window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }

async function deleteLeave(id){ if(!confirm('Delete leave '+id+'?')) return; if (window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const p=new URLSearchParams(); p.append('id', id); const res = await CRUD.post('api/leaves.php?action=delete', p); if (res.success) { window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess(res.message||'Deleted'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed'); } catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed: '+e.message);} finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }

async function saveLeave(){ const form = document.getElementById('addLeaveForm'); const params = new FormData(form); if (!params.get('employee')) { window.CRUD && CRUD.toastError && CRUD.toastError('Employee required'); return; } const modalEl = document.getElementById('addLeaveModal'); window.CRUD && CRUD.modalLoadingStart && CRUD.modalLoadingStart(modalEl); try{ const res = await CRUD.post('api/leaves.php?action=save', params); if (res.success) { bootstrap.Modal.getOrCreateInstance(modalEl).hide(); window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess(res.message||'Saved'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Save failed: '+(res.message||res.error||'Unknown')); } catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Request failed: '+e.message); } finally{ window.CRUD && CRUD.modalLoadingStop && CRUD.modalLoadingStop(modalEl); } }
