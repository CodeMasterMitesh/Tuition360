// employee.js
function initEmployee(){ try { initAdvancedTable('#employee-table'); } catch(e){ console.error('initEmployee failed', e); } const c=document.querySelector('.dashboard-container'); if(c) c.classList.add('show'); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', initEmployee); else try{ initEmployee(); }catch(e){console.error(e);} 

function exportToExcel(){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>{ window.location.href='?page=employee&export=excel'; if(window.CRUD && CRUD.hideLoading) CRUD.hideLoading(); },1000); }
function printTable(){ const table=document.getElementById('employee-table').cloneNode(true); const printWindow=window.open('','_blank'); printWindow.document.write(`<html><head><title>Employee</title></head><body><h2>Employee</h2>${table.outerHTML}</body></html>`); printWindow.document.close(); printWindow.print(); }
function refreshTable(){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>location.reload(),1000); }

async function editEmployee(id){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const res=await CRUD.get(`api/employee.php?action=get&id=${encodeURIComponent(id)}`); if(res.success&&res.data){ const e=res.data; document.getElementById('employeeId').value=e.id||''; document.querySelector('#addEmployeeForm [name="name"]').value=e.name||''; document.querySelector('#addEmployeeForm [name="email"]').value=e.email||''; document.querySelector('#addEmployeeForm [name="phone"]').value=e.mobile||e.phone||''; document.getElementById('employeeBranch') && (document.getElementById('employeeBranch').value=e.branch_id||0); const form=document.getElementById('addEmployeeForm'); if(form) Array.from(form.elements).forEach(el=>el.disabled=false); document.querySelector('#addEmployeeModal .modal-title') && (document.querySelector('#addEmployeeModal .modal-title').innerText='Edit Employee'); const saveBtn=document.querySelector('#addEmployeeModal .btn-primary'); if(saveBtn){ saveBtn.style.display=''; saveBtn.innerText='Update Employee'; } bootstrap.Modal.getOrCreateInstance(document.getElementById('addEmployeeModal')).show(); } else { window.CRUD && CRUD.toastError && CRUD.toastError('Employee not found'); } }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Failed: '+e.message); } finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }

async function viewEmployee(id){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const res=await CRUD.get(`api/employee.php?action=get&id=${encodeURIComponent(id)}`); if(res.success&&res.data){ const e=res.data; document.getElementById('employeeId').value=e.id||''; document.querySelector('#addEmployeeForm [name="name"]').value=e.name||''; document.querySelector('#addEmployeeForm [name="email"]').value=e.email||''; document.querySelector('#addEmployeeForm [name="phone"]').value=e.mobile||e.phone||''; document.getElementById('employeeBranch') && (document.getElementById('employeeBranch').value=e.branch_id||0); const form=document.getElementById('addEmployeeForm'); if(form) Array.from(form.elements).forEach(el=>el.disabled=true); const saveBtn=document.querySelector('#addEmployeeModal .btn-primary'); if(saveBtn) saveBtn.style.display='none'; document.querySelector('#addEmployeeModal .modal-title') && (document.querySelector('#addEmployeeModal .modal-title').innerText='View Employee'); bootstrap.Modal.getOrCreateInstance(document.getElementById('addEmployeeModal')).show(); } else { window.CRUD && CRUD.toastError && CRUD.toastError('Employee not found'); } }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Failed: '+e.message); } finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }

async function deleteEmployee(id){ if(!confirm('Delete employee '+id+'?')) return; if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const p=new URLSearchParams(); p.append('id', id); const res=await CRUD.post('api/employee.php?action=delete', p); if(res.success){ window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess('Deleted'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed'); }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed: '+e.message);} finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }

async function saveEmployee(){ const form=document.getElementById('addEmployeeForm'); const params=new FormData(form); if(!params.get('name')){ window.CRUD && CRUD.toastError && CRUD.toastError('Name required'); return; } const modalEl=document.getElementById('addEmployeeModal'); window.CRUD && CRUD.modalLoadingStart && CRUD.modalLoadingStart(modalEl); try{ const id=params.get('id'); const action = id ? 'update' : 'create'; const res=await CRUD.post('api/employee.php?action='+action, params); if(res.success){ bootstrap.Modal.getOrCreateInstance(modalEl).hide(); window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess(res.message||'Saved'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Save failed: '+(res.message||res.error||'Unknown')); }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Request failed: '+e.message); } finally{ window.CRUD && CRUD.modalLoadingStop && CRUD.modalLoadingStop(modalEl); } }
