// fees.js
function initFees(){ try { initAdvancedTable('#fees-table'); } catch(e){ console.error('initFees failed', e); } const c=document.querySelector('.dashboard-container'); if(c) c.classList.add('show'); }
if(document.readyState==='loading') document.addEventListener('DOMContentLoaded', initFees); else try{ initFees(); }catch(e){console.error(e);} 

function exportToExcel(){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>{ window.location.href='?page=fees&export=excel'; if(window.CRUD && CRUD.hideLoading) CRUD.hideLoading(); },800); }
function refreshTable(){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); setTimeout(()=>location.reload(),700); }
async function viewFee(id){ if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const res=await CRUD.get(`api/fees.php?action=get&id=${encodeURIComponent(id)}`); if(res.success&&res.data){ const f=res.data; document.getElementById('feeId').value=f.id||''; document.querySelector('#addFeeForm [name="student"]').value=f.student||''; document.querySelector('#addFeeForm [name="course"]').value=f.course||''; document.querySelector('#addFeeForm [name="amount"]').value=f.amount||''; document.querySelector('#addFeeForm [name="date"]').value=f.date||''; const form=document.getElementById('addFeeForm'); if(form) Array.from(form.elements).forEach(el=>el.disabled=true); const saveBtn=document.querySelector('#addFeeModal .btn-primary'); if(saveBtn) saveBtn.style.display='none'; document.querySelector('#addFeeModal .modal-title').innerText='View Fee'; bootstrap.Modal.getOrCreateInstance(document.getElementById('addFeeModal')).show(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Record not found'); }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Failed: '+e.message);} finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }
async function deleteFee(id){ if(!confirm('Delete fee '+id+'?')) return; if(window.CRUD && CRUD.showLoading) CRUD.showLoading('tableContainer'); try{ const p=new URLSearchParams(); p.append('id', id); const res=await CRUD.post('api/fees.php?action=delete', p); if(res.success){ window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess('Deleted'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed'); }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Delete failed: '+e.message);} finally{ window.CRUD && CRUD.hideLoading && CRUD.hideLoading(); } }
async function saveFee(){ const form=document.getElementById('addFeeForm'); const params=new FormData(form); if(!params.get('student')){ window.CRUD && CRUD.toastError && CRUD.toastError('Student required'); return; } const modalEl=document.getElementById('addFeeModal'); window.CRUD && CRUD.modalLoadingStart && CRUD.modalLoadingStart(modalEl); try{ const res=await CRUD.post('api/fees.php?action=save', params); if(res.success){ bootstrap.Modal.getOrCreateInstance(modalEl).hide(); window.CRUD && CRUD.toastSuccess && CRUD.toastSuccess(res.message||'Saved'); refreshTable(); } else window.CRUD && CRUD.toastError && CRUD.toastError('Save failed: '+(res.message||res.error||'Unknown')); }catch(e){ window.CRUD && CRUD.toastError && CRUD.toastError('Request failed: '+e.message);} finally{ window.CRUD && CRUD.modalLoadingStop && CRUD.modalLoadingStop(modalEl); } }
